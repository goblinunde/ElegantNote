name: Build LaTeX and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # ç¼–è¯‘ LaTeX æ•™ç¨‹
      - name: ğŸ”§ Compile latex-tutorial.tex
        uses: xu-cheng/latex-action@v3
        with:
          root_file: latex-tutorial.tex
          latexmk_use_xelatex: true
      
      # ç¼–è¯‘å®å˜å‡½æ•°ç¬”è®°
      - name: ğŸ“ Compile real-analysis-notes.tex
        uses: xu-cheng/latex-action@v3
        with:
          root_file: real-analysis-notes.tex
          latexmk_use_xelatex: true
      
      # ç¼–è¯‘å…­å¤§å®šç†äº’è¯
      - name: ğŸ“Š Compile six-theorems.tex
        uses: xu-cheng/latex-action@v3
        with:
          root_file: six-theorems.tex
          latexmk_use_xelatex: true
      
      - name: ğŸ“¦ Upload PDF artifacts
        uses: actions/upload-artifact@v4
        with:
          name: elegantnote-pdfs
          path: |
            latex-tutorial.pdf
            real-analysis-notes.pdf
            six-theorems.pdf
          retention-days: 30
      
      - name: ğŸ·ï¸ Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            latex-tutorial.pdf
            real-analysis-notes.pdf
            six-theorems.pdf
          body: |
            ## ğŸ“š ElegantNote æ–‡æ¡£åˆé›†
            
            è‡ªåŠ¨æ„å»ºçš„ PDF æ–‡æ¡£ï¼ŒåŸºäº ElegantNote æ¨¡æ¿ã€‚
            
            ### åŒ…å«æ–‡æ¡£
            - **latex-tutorial.pdf** - LaTeX æ•°å­¦ç¬¦å·ä¸è¯­æ³•å¿«é€Ÿå‚è€ƒæ•™ç¨‹
            - **real-analysis-notes.pdf** - å®å˜å‡½æ•°ç¬”è®°
            - **six-theorems.pdf** - æ•°å­¦åˆ†æå…­å¤§å®šç†çš„ç›¸äº’è¯æ˜
            
            ### æ›´æ–°å†…å®¹
            - æŸ¥çœ‹ [CHANGELOG](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) è·å–è¯¦ç»†æ›´æ”¹
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # è‡ªåŠ¨å‘å¸ƒæœ€æ–°ç‰ˆæœ¬åˆ° latest release
  update-latest:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: elegantnote-pdfs
      
      - name: ğŸ”„ Update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Build"
          files: |
            latex-tutorial.pdf
            real-analysis-notes.pdf
            six-theorems.pdf
          body: |
            ## ğŸš€ æœ€æ–°è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
            
            æ­¤ Release ä¼šåœ¨æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨æ›´æ–°ã€‚
            
            ### åŒ…å«æ–‡æ¡£
            - **latex-tutorial.pdf** - LaTeX æ•°å­¦ç¬¦å·ä¸è¯­æ³•å¿«é€Ÿå‚è€ƒæ•™ç¨‹
            - **real-analysis-notes.pdf** - å®å˜å‡½æ•°ç¬”è®° (30é¡µ)
            - **six-theorems.pdf** - æ•°å­¦åˆ†æå…­å¤§å®šç†çš„ç›¸äº’è¯æ˜ (25é¡µ)
            
            **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **æäº¤**: ${{ github.sha }}
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
