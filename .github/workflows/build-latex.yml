name: Build LaTeX and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup TinyTeX
        uses: r-lib/actions/setup-tinytex@v2
        env:
          TINYTEX_INSTALLER: TinyTeX-1
      
      - name: ğŸ“¦ Install LaTeX packages
        run: |
          tlmgr install ctex fontawesome5 pgfplots cancel ulem enumitem \
            booktabs mdframed zref needspace titlesec appendix \
            listings xcolor hyperref cleveref caption footmisc \
            tikz-cd pgf fancyhdr geometry lastpage etoolbox \
            xkeyval environ trimspaces sourcesanspro sourcecodepro \
            xecjk ctexbook
      
      - name: ğŸ”¨ Compile LaTeX document
        run: |
          xelatex -interaction=nonstopmode latex-tutorial.tex
          xelatex -interaction=nonstopmode latex-tutorial.tex
      
      - name: ğŸ“¦ Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: latex-tutorial-pdf
          path: latex-tutorial.pdf
          retention-days: 30
      
      - name: ğŸ·ï¸ Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            latex-tutorial.pdf
          body: |
            ## ğŸ“š LaTeX æ•°å­¦ç¬¦å·ä¸è¯­æ³•å¿«é€Ÿå‚è€ƒæ•™ç¨‹
            
            è‡ªåŠ¨æ„å»ºçš„ PDF æ–‡æ¡£ï¼ŒåŸºäº ElegantNote æ¨¡æ¿ã€‚
            
            ### æ›´æ–°å†…å®¹
            - æŸ¥çœ‹ [CHANGELOG](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) è·å–è¯¦ç»†æ›´æ”¹
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # è‡ªåŠ¨å‘å¸ƒæœ€æ–°ç‰ˆæœ¬åˆ° latest release
  update-latest:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: latex-tutorial-pdf
      
      - name: ğŸ”„ Update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Latest Build"
          files: latex-tutorial.pdf
          body: |
            ## ğŸš€ æœ€æ–°è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
            
            æ­¤ Release ä¼šåœ¨æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨æ›´æ–°ã€‚
            
            **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **æäº¤**: ${{ github.sha }}
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
